<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LinuxDO论坛实时快照</title>
    <meta
      name="description"
      content="LinuxDO论坛实时快照服务，提供历史快照浏览、时间精确查询等功能。"
    />
    <meta name="keywords" content="LinuxDO,论坛快照,LinuxDO论坛,LinuxDO快照" />
    <meta name="author" content="LinuxDO团队" />
    <meta name="robots" content="index, follow" />
    <meta name="revisit-after" content="1 days" />
    <meta property="og:title" content="LinuxDO实时快照" />
    <meta
      property="og:description"
      content="自动记录LinuxDO论坛，支持历史查询和精确时间搜索的监控系统。"
    />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://linuxdo.wen.bar/" />
    <meta
      property="og:image"
      content="https://linuxdo.wen.bar/static/logo.png"
    />
    <link rel="canonical" href="https://linuxdo.wen.bar/" />
    <!-- 移动设备支持 -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="format-detection" content="telephone=no" />
    <!-- 结构化数据 - JSON-LD格式 -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "SoftwareApplication",
        "name": "LinuxDO实时快照",
        "description": "LinuxDO论坛实时快照服务，提供高频率自动截图、历史快照浏览、时间精确查询等功能",
        "applicationCategory": "MonitoringApplication",
        "operatingSystem": "All",
        "offers": {
          "@type": "Offer",
          "price": "0",
          "priceCurrency": "CNY"
        },
        "provider": {
          "@type": "Organization",
          "name": "LinuxDO",
          "url": "https://linuxdo.wen.bar/"
        }
      }
    </script>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
      .screenshot-card:hover .hover-overlay {
        opacity: 1;
      }
      .pagination-btn.active {
        background-color: #3b82f6;
        color: white;
      }
      .pagination-btn.disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      /* 日期选择器样式 */
      input[type="datetime-local"] {
        padding: 0.5rem;
        border: 1px solid #e2e8f0;
        border-radius: 0.375rem;
      }
      /* 标签切换样式 */
      .tab-btn {
        padding: 0.5rem 1rem;
        border-bottom: 2px solid transparent;
      }
      .tab-btn.active {
        border-bottom-color: #3b82f6;
        color: #3b82f6;
        font-weight: 600;
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
      <header class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800">LinuxDO快照</h1>
        <p class="text-gray-600">实时更新支持快速查找和搜索</p>
        <p id="last-update" class="text-sm text-gray-500 mt-1">
          上次更新: <span></span>
        </p>
        <div class="mt-3 flex space-x-2">
          <a
            href="#"
            id="latest-link"
            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded inline-block"
          >
            查看最新截图
          </a>
          <a
            href="#"
            id="latest-html-link"
            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded inline-block"
          >
            查看最新HTML
          </a>
        </div>
      </header>

      <!-- 标签切换 -->
      <div class="bg-white rounded-lg shadow-md p-4 mb-6">
        <div class="flex border-b">
          <button class="tab-btn active" data-tab="screenshots">
            截图快照
          </button>
          <button class="tab-btn" data-tab="html">HTML快照</button>
        </div>
      </div>

      <!-- 搜索和筛选区域 -->
      <div class="bg-white rounded-lg shadow-md p-4 mb-6">
        <h2 class="text-lg font-bold text-gray-800 mb-3">搜索快照</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >开始时间</label
            >
            <input type="datetime-local" id="start-time" class="w-full" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >结束时间</label
            >
            <input type="datetime-local" id="end-time" class="w-full" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >精确时间</label
            >
            <input type="datetime-local" id="exact-time" class="w-full" />
          </div>
          <div class="flex items-end">
            <button
              id="search-btn"
              class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded w-full md:w-auto"
            >
              搜索
            </button>
            <button
              id="reset-btn"
              class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded ml-2"
            >
              重置
            </button>
          </div>
        </div>
      </div>

      <!-- 快照内容区域 -->
      <div class="tab-content active" id="screenshots-tab">
        <!-- 快照预览区域 -->
        <div
          id="screenshots-container"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"
        ></div>
      </div>

      <div class="tab-content hidden" id="html-tab">
        <!-- HTML快照预览区域 -->
        <div
          id="html-container"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"
        ></div>
      </div>

      <!-- 分页控制区域 -->
      <div class="mt-8 flex justify-center" id="pagination-container">
        <button
          class="pagination-btn mr-2 px-3 py-1 rounded border"
          id="prev-page"
        >
          上一页
        </button>
        <div id="page-numbers" class="flex space-x-1"></div>
        <button
          class="pagination-btn ml-2 px-3 py-1 rounded border"
          id="next-page"
        >
          下一页
        </button>
      </div>

      <!-- 无快照时显示提示 -->
      <div id="no-items" class="text-center py-12 hidden">
        <p class="text-gray-600 text-lg">没有找到符合条件的内容</p>
      </div>

      <!-- API 信息 -->
      <div class="mt-12 bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">API 接口</h2>
        <div class="space-y-4">
          <div>
            <h3 class="font-medium text-gray-700">获取所有快照列表：</h3>
            <code class="bg-gray-100 px-2 py-1 rounded text-sm"
              >/api/screenshots?page=1&page_size=12</code
            >
          </div>
          <div>
            <h3 class="font-medium text-gray-700">获取特定时间范围的快照：</h3>
            <code class="bg-gray-100 px-2 py-1 rounded text-sm"
              >/api/screenshots?start_time=20240101_000000&end_time=20240131_235959</code
            >
          </div>
          <div>
            <h3 class="font-medium text-gray-700">获取特定快照：</h3>
            <code class="bg-gray-100 px-2 py-1 rounded text-sm"
              >/api/screenshot/{timestamp}</code
            >
          </div>
          <div>
            <h3 class="font-medium text-gray-700">获取最新快照：</h3>
            <code class="bg-gray-100 px-2 py-1 rounded text-sm"
              >/api/latest</code
            >
          </div>
          <div>
            <h3 class="font-medium text-gray-700">获取所有HTML快照列表：</h3>
            <code class="bg-gray-100 px-2 py-1 rounded text-sm"
              >/api/html_files?page=1&page_size=12</code
            >
          </div>
          <div>
            <h3 class="font-medium text-gray-700">获取特定HTML快照：</h3>
            <code class="bg-gray-100 px-2 py-1 rounded text-sm"
              >/api/html/{timestamp}</code
            >
          </div>
          <div>
            <h3 class="font-medium text-gray-700">获取最新HTML快照：</h3>
            <code class="bg-gray-100 px-2 py-1 rounded text-sm"
              >/api/latest_html</code
            >
          </div>
        </div>
      </div>

      <!-- 页脚 -->
      <footer class="mt-12 text-center text-gray-500 text-sm">
        <p>
          快照服务 &copy; {{ now().year }} |
          <a href="https://linux.do/" class="hover:underline">LinuxDO论坛</a>
        </p>
      </footer>
    </div>

    <script>
      // 页面状态
      const state = {
        currentPage: 1,
        pageSize: 12,
        totalPages: 1,
        totalCount: 0,
        startTime: null,
        endTime: null,
        exactTime: null,
        isLoading: false,
        autoRefreshInterval: 3 * 60 * 1000, // 3分钟自动刷新一次
        lastRefreshTime: 0,
        currentTab: "screenshots", // 当前选中的标签页
      };

      // DOM 元素
      const elements = {
        screenshotsTab: document.getElementById("screenshots-tab"),
        htmlTab: document.getElementById("html-tab"),
        tabButtons: document.querySelectorAll(".tab-btn"),
        screenshotsContainer: document.getElementById("screenshots-container"),
        htmlContainer: document.getElementById("html-container"),
        noItems: document.getElementById("no-items"),
        lastUpdate: document.querySelector("#last-update span"),
        pagination: document.getElementById("pagination-container"),
        pageNumbers: document.getElementById("page-numbers"),
        prevBtn: document.getElementById("prev-page"),
        nextBtn: document.getElementById("next-page"),
        startTimeInput: document.getElementById("start-time"),
        endTimeInput: document.getElementById("end-time"),
        exactTimeInput: document.getElementById("exact-time"),
        searchBtn: document.getElementById("search-btn"),
        resetBtn: document.getElementById("reset-btn"),
        latestLink: document.getElementById("latest-link"),
        latestHtmlLink: document.getElementById("latest-html-link"),
      };

      // 初始化
      function init() {
        // 绑定事件
        elements.prevBtn.addEventListener("click", goToPrevPage);
        elements.nextBtn.addEventListener("click", goToNextPage);
        elements.searchBtn.addEventListener("click", search);
        elements.resetBtn.addEventListener("click", resetFilters);
        elements.latestLink.addEventListener("click", openLatestScreenshot);
        elements.latestHtmlLink.addEventListener("click", openLatestHtml);

        // 标签页切换
        elements.tabButtons.forEach((btn) => {
          btn.addEventListener("click", function () {
            // 移除其他标签页的active类
            elements.tabButtons.forEach((b) => b.classList.remove("active"));
            // 为当前标签页添加active类
            this.classList.add("active");

            // 隐藏所有内容区域
            document.querySelectorAll(".tab-content").forEach((content) => {
              content.classList.add("hidden");
              content.classList.remove("active");
            });

            // 显示当前内容区域
            const tabName = this.getAttribute("data-tab");
            const tabContent = document.getElementById(`${tabName}-tab`);
            tabContent.classList.remove("hidden");
            tabContent.classList.add("active");

            // 更新当前标签页状态
            state.currentTab = tabName;

            // 重置分页并加载数据
            state.currentPage = 1;
            loadItems();
          });
        });

        // 添加页面可见性变化监听
        document.addEventListener("visibilitychange", handleVisibilityChange);

        // 日期输入框互斥逻辑
        elements.exactTimeInput.addEventListener("input", function () {
          if (this.value) {
            elements.startTimeInput.disabled = true;
            elements.endTimeInput.disabled = true;
          } else {
            elements.startTimeInput.disabled = false;
            elements.endTimeInput.disabled = false;
          }
        });

        elements.startTimeInput.addEventListener("input", function () {
          if (this.value || elements.endTimeInput.value) {
            elements.exactTimeInput.disabled = true;
          } else {
            elements.exactTimeInput.disabled = false;
          }
        });

        elements.endTimeInput.addEventListener("input", function () {
          if (this.value || elements.startTimeInput.value) {
            elements.exactTimeInput.disabled = true;
          } else {
            elements.exactTimeInput.disabled = false;
          }
        });

        // 首次加载数据
        loadItems();

        // 设置自动刷新
        setInterval(function () {
          if (
            !state.isLoading &&
            document.visibilityState === "visible" &&
            Date.now() - state.lastRefreshTime > state.autoRefreshInterval
          ) {
            loadItems();
          }
        }, 60000); // 每分钟检查一次是否需要刷新
      }

      // 处理页面可见性变化
      function handleVisibilityChange() {
        if (
          document.visibilityState === "visible" &&
          Date.now() - state.lastRefreshTime > state.autoRefreshInterval
        ) {
          loadItems();
        }
      }

      // 加载快照数据
      function loadItems() {
        // 防止重复加载
        if (state.isLoading) return;
        state.isLoading = true;

        // 构建API URL
        let apiUrl =
          state.currentTab === "screenshots"
            ? "/api/screenshots"
            : "/api/html_files";
        apiUrl += `?page=${state.currentPage}&page_size=${state.pageSize}`;

        // 添加时间筛选参数
        if (state.exactTime) {
          apiUrl += `&exact_time=${state.exactTime}`;
        } else {
          if (state.startTime) {
            apiUrl += `&start_time=${state.startTime}`;
          }
          if (state.endTime) {
            apiUrl += `&end_time=${state.endTime}`;
          }
        }

        // 发起API请求
        fetch(apiUrl)
          .then((response) => {
            if (!response.ok) {
              throw new Error("网络响应异常");
            }
            return response.json();
          })
          .then((data) => {
            // 更新状态
            state.totalPages = data.pagination.total_pages;
            state.totalCount = data.pagination.total_count;
            state.lastRefreshTime = Date.now();

            // 更新最后更新时间显示
            const now = new Date();
            elements.lastUpdate.textContent = `${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;

            // 渲染数据
            if (state.currentTab === "screenshots") {
              renderScreenshots(data.items);
            } else {
              renderHtmlFiles(data.items);
            }

            // 更新分页控件
            renderPagination();

            // 显示或隐藏无数据提示
            elements.noItems.classList.toggle("hidden", data.items.length > 0);
          })
          .catch((error) => {
            console.error("加载数据失败:", error);
          })
          .finally(() => {
            state.isLoading = false;
          });
      }

      // 渲染截图列表
      function renderScreenshots(screenshots) {
        elements.screenshotsContainer.innerHTML = "";

        screenshots.forEach((item) => {
          const card = document.createElement("div");
          card.className =
            "screenshot-card bg-white rounded-lg shadow-md overflow-hidden relative";

          // 缩略图
          const img = document.createElement("img");
          img.src = `/static/${item.thumbnail}`;
          img.alt = `截图 ${item.datetime}`;
          img.className = "w-full h-32 md:h-40 object-cover";
          img.loading = "lazy";

          // 信息区域
          const info = document.createElement("div");
          info.className = "p-3";

          const datetime = document.createElement("div");
          datetime.className = "text-sm text-gray-700";
          datetime.textContent = item.datetime;

          info.appendChild(datetime);

          // 操作区域
          const actions = document.createElement("div");
          actions.className = "flex justify-between mt-2";

          // 查看原图按钮
          const viewBtn = document.createElement("a");
          viewBtn.href = `/api/screenshot/${item.timestamp}`;
          viewBtn.className =
            "text-xs bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded";
          viewBtn.textContent = "查看原图";
          viewBtn.target = "_blank";

          // 添加查看HTML按钮（如果有）
          const htmlBtn = document.createElement("a");
          if (item.html) {
            htmlBtn.href = `/api/html/${item.timestamp}`;
            htmlBtn.className =
              "text-xs bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded";
            htmlBtn.textContent = "查看HTML";
            htmlBtn.target = "_blank";
          } else {
            htmlBtn.className =
              "text-xs bg-gray-300 text-gray-500 px-2 py-1 rounded cursor-not-allowed";
            htmlBtn.textContent = "无HTML";
          }

          actions.appendChild(viewBtn);
          actions.appendChild(htmlBtn);

          info.appendChild(actions);

          card.appendChild(img);
          card.appendChild(info);

          elements.screenshotsContainer.appendChild(card);
        });
      }

      // 渲染HTML文件列表
      function renderHtmlFiles(htmlFiles) {
        elements.htmlContainer.innerHTML = "";

        htmlFiles.forEach((item) => {
          const card = document.createElement("div");
          card.className = "bg-white rounded-lg shadow-md overflow-hidden";

          // 信息区域
          const info = document.createElement("div");
          info.className = "p-4";

          const title = document.createElement("div");
          title.className = "font-medium text-gray-800 mb-2";
          title.textContent = `HTML快照 ${item.timestamp}`;

          const datetime = document.createElement("div");
          datetime.className = "text-sm text-gray-600 mb-3";
          datetime.textContent = item.datetime;

          // 操作按钮
          const viewBtn = document.createElement("a");
          viewBtn.href = `/api/html/${item.timestamp}`;
          viewBtn.className =
            "inline-block bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm";
          viewBtn.textContent = "查看HTML";
          viewBtn.target = "_blank";

          info.appendChild(title);
          info.appendChild(datetime);
          info.appendChild(viewBtn);

          card.appendChild(info);
          elements.htmlContainer.appendChild(card);
        });
      }

      // 渲染分页控件
      function renderPagination() {
        // 更新分页按钮状态
        elements.prevBtn.classList.toggle("disabled", state.currentPage <= 1);
        elements.nextBtn.classList.toggle(
          "disabled",
          state.currentPage >= state.totalPages
        );

        // 渲染页码
        elements.pageNumbers.innerHTML = "";

        // 确定要显示的页码范围
        let startPage = Math.max(1, state.currentPage - 2);
        let endPage = Math.min(state.totalPages, startPage + 4);

        // 如果页码不足5个，尝试从前面补充
        if (endPage - startPage < 4) {
          startPage = Math.max(1, endPage - 4);
        }

        // 添加第一页按钮（如果不在显示范围内）
        if (startPage > 1) {
          addPageButton(1);
          if (startPage > 2) {
            addEllipsis();
          }
        }

        // 添加中间的页码
        for (let i = startPage; i <= endPage; i++) {
          addPageButton(i);
        }

        // 添加最后一页按钮（如果不在显示范围内）
        if (endPage < state.totalPages) {
          if (endPage < state.totalPages - 1) {
            addEllipsis();
          }
          addPageButton(state.totalPages);
        }

        // 隐藏分页控件（如果总页数为0或1）
        elements.pagination.classList.toggle("hidden", state.totalPages <= 1);
      }

      // 添加页码按钮
      function addPageButton(pageNum) {
        const btn = document.createElement("button");
        btn.className = `pagination-btn px-3 py-1 rounded border ${
          pageNum === state.currentPage ? "active" : ""
        }`;
        btn.textContent = pageNum;
        btn.addEventListener("click", () => goToPage(pageNum));
        elements.pageNumbers.appendChild(btn);
      }

      // 添加省略号
      function addEllipsis() {
        const span = document.createElement("span");
        span.className = "px-3 py-1";
        span.textContent = "...";
        elements.pageNumbers.appendChild(span);
      }

      // 跳转到指定页
      function goToPage(pageNum) {
        if (
          pageNum !== state.currentPage &&
          pageNum >= 1 &&
          pageNum <= state.totalPages
        ) {
          state.currentPage = pageNum;
          loadItems();
          // 滚动到顶部
          window.scrollTo(0, 0);
        }
      }

      // 上一页
      function goToPrevPage() {
        if (state.currentPage > 1) {
          goToPage(state.currentPage - 1);
        }
      }

      // 下一页
      function goToNextPage() {
        if (state.currentPage < state.totalPages) {
          goToPage(state.currentPage + 1);
        }
      }

      // 搜索
      function search() {
        // 重置页码
        state.currentPage = 1;

        // 获取搜索参数
        if (elements.exactTimeInput.value) {
          // 精确时间搜索
          const date = new Date(elements.exactTimeInput.value);
          state.exactTime = formatTimestamp(date);
          state.startTime = null;
          state.endTime = null;
        } else {
          // 时间范围搜索
          state.exactTime = null;

          if (elements.startTimeInput.value) {
            const startDate = new Date(elements.startTimeInput.value);
            state.startTime = formatTimestamp(startDate);
          } else {
            state.startTime = null;
          }

          if (elements.endTimeInput.value) {
            const endDate = new Date(elements.endTimeInput.value);
            state.endTime = formatTimestamp(endDate);
          } else {
            state.endTime = null;
          }
        }

        // 加载数据
        loadItems();
      }

      // 重置筛选条件
      function resetFilters() {
        elements.startTimeInput.value = "";
        elements.endTimeInput.value = "";
        elements.exactTimeInput.value = "";

        elements.startTimeInput.disabled = false;
        elements.endTimeInput.disabled = false;
        elements.exactTimeInput.disabled = false;

        state.startTime = null;
        state.endTime = null;
        state.exactTime = null;
        state.currentPage = 1;

        loadItems();
      }

      // 格式化时间戳
      function formatTimestamp(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        const hours = String(date.getHours()).padStart(2, "0");
        const minutes = String(date.getMinutes()).padStart(2, "0");
        const seconds = String(date.getSeconds()).padStart(2, "0");

        return `${year}${month}${day}_${hours}${minutes}${seconds}`;
      }

      // 打开最新截图
      function openLatestScreenshot(e) {
        e.preventDefault();

        fetch("/api/latest")
          .then((response) => {
            if (!response.ok) {
              throw new Error("网络响应异常");
            }
            return response.json();
          })
          .then((data) => {
            window.open(data.direct_url, "_blank");
          })
          .catch((error) => {
            console.error("获取最新截图失败:", error);
            alert("获取最新截图失败");
          });
      }

      // 打开最新HTML快照
      function openLatestHtml(e) {
        e.preventDefault();

        fetch("/api/latest_html")
          .then((response) => {
            if (!response.ok) {
              throw new Error("网络响应异常");
            }
            return response.json();
          })
          .then((data) => {
            window.open(data.direct_url, "_blank");
          })
          .catch((error) => {
            console.error("获取最新HTML快照失败:", error);
            alert("获取最新HTML快照失败");
          });
      }

      // 页面加载完成后初始化
      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
